## üßÆ CPU
–í —ç—Ç–æ–π –≥–ª–∞–≤–µ –º—ã —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º –º–µ—Ö–∞–Ω–∏–∑–º—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ __–≤—ã—á–∏—Å–ª–µ–Ω–∏–π__ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.    
–°–∫–∞–∂–µ–º, —É –Ω–∞—Å –µ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏—è `f(**kwargs) -> int`, –∫–æ—Ç–æ—Ä–∞—è —á–∏—Å—Ç–æ —Å–ª—É—á–∞–π–Ω–æ –æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏–µ–π [BusyBeaver](https://en.wikipedia.org/wiki/Busy_beaver): 
```python
# views.py
...

@api_view(['POST'])  # Some DRF magic
def bb_view(request: json):
    iterations = busy_beaver(**request.get('states'))
    logging.info(f"HALTED AFTER: {iterations}")
```
–ö–∞–∫ –≤—ã –ø–æ–Ω–∏–º–∞–µ—Ç–µ, –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤ `states`, –∑–∞–ø—Ä–æ—Å –∫ –¥–∞–Ω–Ω–æ–º—É view –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è _–æ—á–µ–Ω—å –¥–æ–ª–≥–æ_; –∏ –±—Ä–∞—É–∑–µ—Ä –≤—ã–∫–∏–Ω–µ—Ç —Ç–∞–π–º–∞—É—Ç. –ß—Ç–æ —Ö—É–∂–µ, –µ—Å–ª–∏ –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Ä–µ—à–∞—Ç –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤–µ–ª–∏–∫–æ–ª–µ–ø–Ω–æ–π —Ñ–∏—á–µ–π –≤–∞—à–µ–≥–æ —Å–∞–π—Ç–∞, –≤—Å–µ –≤–æ—Ä–∫–µ—Ä—ã –æ–±—Å–ª—É–∂–∏–≤–∞—é—â–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–≤ —Ç–∞–∫–∂–µ –∑–∞–ª–∏–ø–Ω—É—Ç –≤ –æ–∂–∏–¥–∞–Ω–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏, —á—Ç–æ —Å–¥–µ–ª–∞–µ—Ç –ª—é–±–æ–π –∑–∞–ø—Ä–æ—Å –Ω–∞ –Ω–∞—à —Å–∞–π—Ç __–Ω–µ–æ–±—Å–ª—É–∂–∏–≤–∞–µ–º—ã–º__. –•—É–∂–µ –¥–∞–Ω–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ —É–∂–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å, –ø–æ—ç—Ç–æ–º—É –¥–∞–≤–∞–π—Ç–µ —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º –º–µ—Ö–∞–Ω–∏–∑–º—ã —Ç–æ–≥–æ –∫–∞–∫ —ç—Ç–æ –º–æ–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å.    
–ù—É –∫–æ–Ω–µ—á–Ω–æ –∂–µ –º–æ–∂–Ω–æ –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á –≤ –¥–æ—á–µ—Ä–Ω–∏–µ –ø–æ—Ç–æ–∫–∏ –∏–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å—ã!

## üé¢ Multiprocessing|Threading|Async

### üßµ Threading

–í Python –¥–µ–ª–∞ —Å –ø–æ—Ç–æ–∫–∞–º–∏ –æ–±—Å—Ç–æ—è—Ç –Ω–µ —Ç–∞–∫ –ø—Ä–æ—Å—Ç–æ. –í–∏–Ω–æ–π –≤—Å–µ–º—É —è–≤–ª—è–µ—Ç—Å—è –∑–ª–æ—â–∞—Å—Ç–Ω—ã–π __GIL__ [**G**lobal **I**nterpreter **L**ock]. –û–Ω –ø–æ–∑–≤–æ–ª—è–µ—Ç –ª–∏—à—å **–æ–¥–Ω–æ–º—É** –ø–æ—Ç–æ–∫—É –∏—Å–ø–æ–ª–Ω—è—Ç—å –±–∞–π—Ç–∫–æ–¥. –≠—Ç–æ —Å–¥–µ–ª–∞–Ω–æ –∏–∑ —Å–æ–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø—Ä–æ—Å—Ç–æ—Ç—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä–∞ –∏ –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –ú–Ω–æ–≥–∏–µ, –æ–±—ã—á–Ω–æ —Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ –æ—Ç Python-—Å–æ–æ–±—â–µ—Å—Ç–≤–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç—ã, —Å–ª—ã—à–∞ GIL –Ω–∞—á–∏–Ω–∞—é—Ç –æ—Ä–∞—Ç—å –∫–∞–∫ –≥–∏–µ–Ω—ã, —á—Ç–æ —ç—Ç–æ –∑–∞–º–µ–¥–ª—è–µ—Ç Python, —ç—Ç–æ –∂—É—Ç–∫–æ –Ω–µ —É–¥–æ–±–Ω–æ –∏ —Ç.–ø. –•–æ—Ç—è, —Å—Ç–æ–∏—Ç –æ—Ç–º–µ—Ç–∏—Ç—å, —á—Ç–æ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è—Ö —è–∑—ã–∫–∞ –µ–≥–æ –ø–æ–ø—Ä–æ—Å—Ç—É –Ω–µ—Ç.   
–ù–∞ —Å–∞–º–æ–º –¥–µ–ª–µ, –µ—Å–ª–∏ –ø–æ–Ω–∏–º–∞—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ª–æ–∫–∞, —Ç–æ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ –ø–æ –ø–æ–ª–Ω–æ–π. 
–¢—Ä–µ–ø–∏—â–∏—Ç–µ, —ç—Ç–æ __GIL__ –≤ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–Ω–æ–π –∏–Ω—Ç–µ–ø—Ä–µ—Ç–∞—Ü–∏–∏ __CPython__:
```C
static PyThread_type_lock interpreter_lock = 0; /* This is the GIL */
```
–î–∞, —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –±—É–ª–µ–≤–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –≤ —Ç–µ—Ä–º–∏–Ω–∞—Ö —è–∑—ã–∫–∞ `C`. –°–∞–º–∞ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è —è–∑—ã–∫–∞ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –µ—â–µ 2 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–º–µ–Ω–Ω—ã–µ –¥–ª—è –º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è `gil_mutex` –∏ `gil_cond` —Å –∫—É—á–µ–π –º–∞–∫—Ä–æ—Å–æ–≤ –¥–ª—è –∏—Ö –ª–æ–≥–∏–∫–∏. –í—ã –º–æ–∂–µ—Ç–µ [–ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—é–¥–∞](https://github.com/python/cpython/blob/master/Python/ceval_gil.h) —á—Ç–æ–±—ã –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ GIL'–∞.     
–î–ª—è –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –∫–∞–∂–¥–æ–≥–æ –ø–æ—Ç–æ–∫–∞ –º—ã –¥–æ–ª–∂–Ω—ã —Å–¥–µ–ª–∞—Ç—å `acquire_gil`, –∞ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π –¥–æ —ç—Ç–æ–≥–æ –ø–æ—Ç–æ–∫ –¥–æ–ª–∂–µ–Ω —Å–¥–µ–ª–∞—Ç—å `release_gil`. –¢–∞–∫–æ–π –ø—Ä–æ—Ü–µ—Å—Å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∫–∞–∂–¥—ã–π —Ä–∞–∑ –∫–æ–≥–¥–∞ –º—ã –∏—Å–ø–æ–ª–Ω—è–µ–º—Å—è –∑–∞–¥–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—Ä–µ–º–µ–Ω–∏ –∏–ª–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –±–ª–æ–∫–∏—Ä—É—é—â–∏–π –≤—ã–∑–æ–≤.

–ß—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –ø–æ—Ç–æ–∫ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É `threading`. –î–∞–≤–∞–π—Ç–µ —É–ª—É—á—à–∏–º –ø—Ä–∏–º–µ—Ä –∏–∑ Introduction.

```python linenums="1"
from typing import List
from threading import Thread
import requests

def send_request(url: str, result: List[str]) -> bytes:
  result.append(requests.get(url).content)  # disgusting write from within a thread

def manage_requests(targets_file: str) -> List[bytes]:
  reponses: List[str] = []
  thread_pool: List[Thread] = []  # create a thread pool
  with open(targets, "r") as f:
    for url in f:
        thread_pool.append(Thread(target=send_request, args=(url, reponses,))) # spawn a thread
        thread_pool[-1].start()  # start it
        responses.append(send_request(url))
  [thread.join for thread in thread_pool]  # join threads and await results
  return responses

if __name__ == '__main__':
  results = manage_requests("my_req_urls")
  ... # Process results
```

### üìà concurent.futures

–¶–∏—Ç–∏—Ä—É—è —É–º–Ω—ã—Ö –ª—é–¥–µ–π

!!! quote "Raymond Hettinger"
    There's got to be a better way to do this!

–ö–æ–Ω–µ—á–Ω–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ Python —Ä–∞—Å—Ç–µ—Ç –∏ —Ç–µ–ø–µ—Ä—å —É –Ω–∞—Å –µ—Å—Ç—å –±–æ–ª–µ–µ –ø—Ä–∏—è—Ç–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –ø–æ–¥–æ–±–Ω—ã—Ö –∑–∞–¥–∞—á: `concurent.futures`. –≠—Ç–æ—Ç –º–æ–¥—É–ª—å —è–≤–ª—è–µ—Ç—Å—è –≤—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–π.

```python linenums="1"
from typing import List
from —Åoncurent import futures
import requests

def send_request(url: str) -> bytes:
  return requests.get(url).content  # now that's much better

def manage_requests(targets_file: str) -> List[bytes]:
  reponses: List[str] = []
  thread_pool: List[Thread] = []  # create a thread pool
  with open(targets, "r") as f:
    with concurrent.futures.ThreadPoolExecutor(max_workers=5) as executor:
    # Start the load operations and mark each future with its URL
    future_to_url = {executor.submit(send_request, url, 60): url for url in f}
    for future in concurrent.futures.as_completed(future_to_url):
        url = future_to_url[future]
        try:
            data = future.result()
        except Exception as e:
            print(f"{url} generated an exception: {e}")
        else:
            print(f"{url} page is {len(data)} bytes")
  return responses


if __name__ == '__main__':
  results = manage_requests("my_req_urls")
  ... # Process results
```

–ù–æ –∑–Ω–∞–µ—Ç–µ —á—Ç–æ?

!!! quote "Raymond Hettinger"
    There's got to be a better way to do this!

–ï—Å–ª–∏ –≤—ã –æ—Ç–º–∞—Ç–∞–µ—Ç–µ –Ω–∞ –¥–≤–∞ –ø—Ä–∏–º–µ—Ä–∞ –≤–≤–µ—Ä—Ö, —Ç–æ —É–≤–∏–¥–∏—Ç–µ, –≤–∞–∂–Ω—É—é —Ñ—Ä–∞–∑—É, —á—Ç–æ —Å–º–µ–Ω–∞ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞ **–ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –±–ª–æ–∫–∏—Ä—É—é—â–µ–º –≤—ã–∑–æ–≤–µ**. –ó–Ω–∞—á–∏—Ç –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ IO –º—ã –º–æ–∂–µ–º –¥–µ–ª–∏–≥–∏—Ä–æ–≤–∞—Ç—å –ø–∏—Ç–æ–Ω—É –∑–∞–¥–∞—á–∏, –ø–æ–∫–∞ –æ–Ω –±—É–¥–µ—Ç –æ–∂–∏–¥–∞—Ç—å –æ—Ç–≤–µ—Ç–∞. –≠—Ç–∞ –∏–¥–µ—è —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω–∞ –¥–ª—è –æ—Å–æ–∑–Ω–∞–Ω–∏—è –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–≥–æ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–¥–∞. 

–¢–æ –æ —á–µ–º —è –ø–∏—à—É –º–æ–∂–Ω–æ –∏–∑–æ–±—Ä–∞–∑–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:
![img](img/gil.png)


### üìû Async

–ù–∞—á–∏–Ω–∞—è —Å Python 3.5 –≤ —è–∑—ã–∫–µ –ø–æ—è–≤–∏–ª–∏—Å—å –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ `async`/`await`, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–∑–≤–æ–ª—è—é—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∑–∞–¥–∞–≤–∞—Ç—å –≤ —É–¥–æ–±–Ω–æ–π —Ñ–æ—Ä–º–µ –≤–æ—Ä–∫—Ñ–ª–æ—É. 

```python linenums=1
import aiohttp
import asyncio

async def send_request(url: str) -> bytes:
    return await requests.get(url).content

async def manage_requests(targets_file: str) -> List[bytes]:
    tasks = []
    with open(target_file, "r") as f:
        for url in f:
            tasks.append(send_request(url))
        responses = await asyncio.gather(*tasks)
    return responses

if __name__ == '__main__':
    loop = asyncio.get_event_loop()  # We need to create an event_loop
    loop.run_until_complete(manage_requests())
```

–î–∞–Ω–Ω—ã–π –º–µ—Ç–æ–¥ –ø—Ä–∏ –∫–∞–∂–¥–æ–º _await_ –±—É–¥–µ—Ç –º–µ–Ω—è—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –ø–æ—Ç–æ–∫ –∏ –¥–µ–ª–∞—Ç—å —Å–ª–µ–¥—É—é—â—É—é –∏—Ç–µ—Ä–∞—Ü–∏—é –≤ —Ü–∏–∫–ª–µ `event_loop`. –û–¥–Ω–∞–∫–æ `requests` –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –≤ —Ç–µ—Ä–º–∏–Ω–∞—Ö –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –ø–∞—Ä–∞–¥–∏–≥–º—ã —è–≤–ª—è–µ—Ç—Å—è __–±–ª–æ–∫–∏—Ä—É—é—â–µ–π__. –î–µ–ª–æ –≤ —Ç–æ–º, —á—Ç–æ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤—ã–∑–æ–≤–æ–≤ –∏ –∂–∞–Ω–≥–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—Ç–æ–∫–∞–º–∏, –≤–∞—à –∫–æ–¥ –Ω–µ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –æ–±—ã–∫–Ω–æ–≤–µ–Ω–Ω—ã—Ö –±–ª–æ–∫–∏—Ä—É—é—â–∏—Ö –≤—ã–∑–æ–≤–æ–≤, –∏–Ω–∞—á–µ, –≤—Å—Ç—Ä–µ—Ç–∏–≤ —Ç–∞–∫–æ–π –≤—ã–∑–æ–≤, –ø–æ—Ç–æ–∫ –ø—Ä–æ—Å—Ç–æ –≤—Å—Ç–∞–Ω–µ—Ç –∏ –±—É–¥–µ—Ç –æ–∂–∏–¥–∞—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è. –ü–æ—ç—Ç–æ–º—É –∫–æ–≥–¥–∞ –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –∫–∞–∫–∏–µ-–ª–∏–±–æ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ —Å AsyncIO, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ–Ω–∞ —Ç–∞–∫–∂–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç `async`/`await`.    
–ù—É –∞ —Ç–µ–ø–µ—Ä—å: 

!!! quote "Raymond Hettinger"
    There's got to be a better way to do this!

### üï∏ aiohttp

–û–¥–Ω–∏–º –∏–∑ –ø—Ä–∏–º–µ—Ä–æ–≤ –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–µ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤–µ–±-–∑–∞–ø—Ä–æ—Å–∞–º–∏ —è–≤–ª—è–µ—Ç—Å—è aiohttp. –û–Ω–∞ –æ–±–µ—Å–ø–µ—á–∏—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–¥–∞ –≤ "–Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–µ–º" —Ñ–æ—Ä–º–∞—Ç–µ:

–°–Ω–∞—á–∞–ª–∞
```shell
pip install aiohttp
```

–ò –∑–∞—Ç–µ–º

```python linenums="1"
from typing import List
import aiohttp
import asyncio

async def fetch(session, url):
    async with session.get(url) as response:
        return await response.text()

async def manage_requests(targets_file: str) -> List[bytes]:
    with open(targets_file, "r") as f:
        async with aiohttp.ClientSession() as session:
            tasks = [tasks.append(fetch(session, url) for url in f]
            return await asyncio.gather(*tasks)
        

if __name__ == '__main__':
    loop = asyncio.get_event_loop()
    loop.run_until_complete(manage_requests())
```
–ì–æ—Ä–∞–∑–¥–æ –ª—É—á—à–µ. –û–¥–Ω–∞–∫–æ –º—ã –ø–æ –ø—Ä–µ–∂–Ω–µ–º—É –Ω–µ –º–æ–∂–µ–º –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π. –î–ª—è —Ç–æ–≥–æ —á—Ç–æ–±—ã –æ–±–æ–π—Ç–∏ —ç—Ç–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –±—ã–ª —Å–¥–µ–ª–∞–Ω `multiprocessing`

### ‚à• Multiprocessing

–ë–ª–∞–≥–æ–¥–∞—Ä—è GIL, –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞, –≤ Python –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø—Ä–æ—Ü–µ—Å—Å—ã. –°—Ä–∞–∑—É –∂–µ –æ –ø–ª–æ—Ö–æ–º: –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–æ—Å—Ö–æ–¥—ã –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –ø–æ—Ç–æ–∫–∞–º–∏, –Ω–µ—Ç —Ä–∞–∑–¥–µ–ª–µ–Ω–Ω–æ–π –ø–∞–º—è—Ç–∏ –º–µ–∂–¥—É –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏. –ù–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å –≤–µ–¥—É—Ç—Å—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é —Å—É–±-–∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä–æ–≤ –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç–∏ —Å –º–µ–Ω—å—à–∏–º–∏ —Ä–∞—Å—Ö–æ–¥–∞–º–∏, –Ω–æ —ç—Ç–æ –≤—Å–µ –µ—â–µ –≤ —Ä–∞–Ω–Ω–µ–π —Å—Ç–∞–¥–∏–∏. –•–æ—Ç—è –≤ CPython —É–∂–µ –µ—Å—Ç—å API.

–î–∞–≤–∞–π—Ç–µ –ø–æ–ø—Ä–æ–±—É–µ–º —É–±—Ä–∞—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –Ω–∞—à–µ–≥–æ view –∏–∑ –Ω–∞—á–∞–ª–∞ –≥–ª–∞–≤–∞:

```python linenums="1"
# views.py
...
from multiprocessing import Process

@api_view(['POST'])  # Some DRF magic
def bb_view(request: json):
    iterations = Process(target = busy_beaver, args=(**request.get('states')))
    logging.info(f"HALTED AFTER: {iterations}")
```

–¢–∞–∫–∂–µ –µ—Å—Ç—å —É–¥–æ–±–Ω—ã–π `Pool` –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–Ω–æ–∂–µ—Å—Ç–≤–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∑–∞ —Ä–∞–∑. –ù–∞–ø—Ä–∏–º–µ—Ä: 
```python linenums="1"
from multiprocessing import Pool

def f(x: int) -> int:
    return x*x

if __name__ == '__main__':
    with Pool(5) as p:
        print(p.map(f, [1, 2, 3]))
```

–¢–µ–ø–µ—Ä—å –Ω–∞—à–∞ –∑–∞–¥–∞—á–∞ –±—É–¥–µ—Ç —Å—á–∏—Ç–∞—Ç—å—Å—è –≤ –∞–±—Å–æ–ª—é—Ç–Ω–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ. –û–¥–Ω–∞–∫–æ —Å—Ç–æ–∏—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –¥–µ—Ä–∂–∞—Ç—å –≤ –≥–æ–ª–æ–≤–µ, —á—Ç–æ –ø–æ—Ç–æ–∫–∏ –∏ –ø—Ä–æ—Ü–µ—Å—Å—ã —Ç–∞–∫–∂–µ –Ω–µ—Å—É—Ç –Ω–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –Ω–∞ –∏—Ö —Å–æ–∑–¥–∞–Ω–∏–µ, –ø–µ—Ä–µ–¥–∞—á—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏ —Ç.–ø. –ü–æ—ç—Ç–æ–º—É –Ω–µ —Å—Ç–æ–∏—Ç –ø—ã—Ç–∞—Ç—å—Å—è —Ä–∞—Å–ø–∞—Ä–∞–ª–ª–µ–ª–∏—Ç—å –∞–±—Å–æ–ª—é—Ç–Ω–æ –∫–∞–∂–¥—É—é –∑–∞–¥–∞—á—É.

## üí™ Celery

–ö–æ–Ω–µ—á–Ω–æ –∂–µ, –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–≥–æ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –µ—Å—Ç—å —Ä–µ—à–µ–Ω–∏—è –∏ –ª—É—á—à–µ! –ï—Å–ª–∏ –º—ã –æ–±—Å–ª—É–∂–∏–≤–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤, —Ç–æ –Ω–∞–º –ø—Ä–æ—Å—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏—Ö –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –∏ –≤—ã—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏—è –æ—á–µ—Ä–µ–¥–µ–π –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –Ω–∞–≥—Ä—É–∑–∫–æ–π. –¢–∞–∫–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç `Celery`.

Celery –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–¥–∞—Ç—å –æ—á–µ–Ω—å –≥–∏–±–∫—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É –ø–æ–¥ –ª—é–±—É—é –Ω–∞–≥—Ä—É–∑–∫—É! –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≤—ã–≥–ª—è–¥–∏—Ç —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:

![img](img/celery.png)

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ, —Å–æ–∑–¥–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –∑–∞–¥–∞—á—É, –∫–æ—Ç–æ—Ä–∞—è –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ –±—Ä–æ–∫–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –ø–æ—Å—Ç–æ—è–Ω–Ω–æ —á–∏—Ç–∞—é—Ç `celery` –≤–æ—Ä–∫–µ—Ä—ã. –ö–∞–∫ —Ç–æ–ª—å–∫–æ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∑–∞–¥–∞—á–µ–π –≤ –æ—á–µ—Ä–µ–¥–∏, –≤–æ—Ä–∫–µ—Ä –Ω–∞—á–∏–Ω–∞–µ—Ç –µ–≥–æ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ, –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å —É–∂–µ —á–µ—Ä–µ–∑ API —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ `celery`.
–í –≤–µ—Ä—Ö–µ–º-–ª–µ–≤–æ–º —É–≥–ª—É —É–∫–∞–∑–∞–Ω Scheduler, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ–º cron-like –∑–∞–¥–∞—á. –¢.–µ. –º—ã –º–æ–∂–µ–º –∑–∞–¥–∞—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä—É—é –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é –∑–∞–¥–∞—á—É, –Ω–∞–ø—Ä–∏–º–µ—Ä, –æ—á–∏—Å—Ç–∏—Ç—å –±–¥ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3 —á–∞—Å–∞ –Ω–æ—á–∏ –∏–ª–∏ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏–Ω–≥ —Å—Ç–æ—Ä–æ–Ω–Ω–µ–º—É —Å–µ—Ä–≤–∏—Å—É. –í—Å–µ —ç—Ç–æ –æ—á–µ–Ω—å –ª–µ–≥–∫–æ —Å–¥–µ–ª–∞—Ç—å —Å `Celery`, –Ω–æ —Å–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∞:

`pip install Celery`

–ª–∏–±–æ –º–æ–∂–Ω–æ –ø–æ–¥—Ç—è–Ω—É—Ç—å —Å—Ä–∞–∑—É –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Å—Ç–µ–∫—É:

`pip install "celery[librabbitmq,redis,auth,msgpack]"`

!!! note "Celery"
    –Ø –Ω–∞—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É—é –æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π, –ø–æ—Å–∫–æ–ª—å–∫—É Celery —É–º–µ–µ—Ç —Ç–∞–∫ –º–Ω–æ–≥–æ, —á—Ç–æ –ø–æ –Ω–µ–º—É –Ω—É–∂–Ω–æ –ø–∏—Å–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—É—é –º–µ—Ç–æ–¥–∏—á–∫—É. [–ü–æ–¥—Ä–æ–±–Ω–µ–µ —Ç—É—Ç](https://docs.celeryproject.org/en/stable/index.html)

–î–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ–∑–¥–∞–¥–∏–º —Ñ–∞–π–ª `celery.py` –≤ –∫–æ—Ä–Ω–µ `proj`, –≥–¥–µ –ª–µ–∂–∏—Ç `settings.py`.
```python linenums="1"
# celery.py
import os
from celery import Celery

# set the default Django settings module for the 'celery' program.
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'proj.settings')

app = Celery('proj')

# Using a string here means the worker doesn't have to serialize
# the configuration object to child processes.
# - namespace='CELERY' means all celery-related configuration keys
#   should have a `CELERY_` prefix.
app.config_from_object('django.conf:settings', namespace='CELERY')

# Load task modules from all registered Django app configs.
app.autodiscover_tasks()
```

–î–æ–±–∞–≤–∏–º —ç—Ç–æ –≤ `__init__.py` –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –∫–ª–∏–µ–Ω—Ç `celery` –º–æ–≥ —É–≤–∏–¥–µ—Ç—å –Ω–∞—à–∏ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:
```python
# This will make sure the app is always imported when
# Django starts so that shared_task will use this app.
from .celery import app as celery_app

__all__ = ('celery_app',)
```

–¢–µ–ø–µ—Ä—å –≤–Ω—É—Ç—Ä–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏ –≤ `tasks.py`
```
- app1/
    - tasks.py
    - models.py
- app2/
    - tasks.py
    - models.py
```

–û–ø—Ä–µ–¥–µ–ª–∏–º –∑–∞–¥–∞—á—É –∏–∑ –Ω–∞—á–∞–ª–∞ –≥–ª–∞–≤—ã –¥–ª—è `Celery`:
```py
from typing import Dict
from my.proj import celery_app

@celery_app.task(name="bb_task")
def busy_beaver(instructions: Dict):
    ...# bb code
```

–û—Ç–ª–∏—á–Ω–æ, —Ç–µ–ø–µ—Ä—å –º—ã –º–æ–∂–µ–º –ø—Ä–æ—Å—Ç–æ –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º –∑–∞–ø—É—Å–∫–∞ –∑–∞–¥–∞—á –Ω–∞ –≤–æ—Ä–∫–µ—Ä–µ -- `delay`. –ü–æ —Å–≤–æ–µ–π —Å—É—Ç–∏ —ç—Ç–æ —Ç–∞–∫–æ–π `apply_async`. [–ó–¥–µ—Å—å](https://docs.celeryproject.org/en/stable/userguide/calling.html) –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ–± —ç—Ç–æ–º –Ω–∞–ø–∏—Å–∞–Ω–æ.
```py
# views.py
...

@api_view(['POST'])  # Some DRF magic
def bb_view(request: json):
    busy_beaver.delay(**request.get('states'))  # start the task
    # logging.info(f"HALTED AFTER: {iterations}")
```
### Results
–û–¥–Ω–∞–∫–æ, –º—ã –Ω–µ —Å–º–æ–∂–µ–º —É–≤–∏–¥–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç(((
–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–µ–∑–ª—å—Ç–∞—Ç–æ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ 
`pip install django-celery-results`
–∏ –¥–æ–±–∞–≤–∏—Ç—å 
```py
# settings.py
INSTALLED_APPS = (
    ...,
    'django_celery_results',
)
```
–∑–∞—Ç–µ–º —Å–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `python manage.py migrate django_celery_results`.    
–î–∞–ª–µ–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –±—ç–∫–µ–Ω–¥ –¥–ª—è –Ω–∞—à–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –∏ –∑–¥–µ—Å—å –º—ã –º–æ–∂–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–π-–¥–æ–±—Ä—ã–π –∫—ç—à.
```py
# celery setting.
CELERY_CACHE_BACKEND = 'default'

# django setting.
CACHES = {
    'default': {
        ...
    }
}
```


### Scheduler
–≠—Ç–æ—Ç –ø–∞–∫–µ—Ç –ø–æ–∑–≤–æ–ª—è–µ—Ç —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –∑–∞–¥–∞—á. –î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ `pip install django-celery-beat`.    
–ó–∞—Ç–µ–º –∑–∞—Ä–µ–≥–µ—Å—Ç—Ä–∏—Ä—É–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ Django:
```py
# settings.py
INSTALLED_APPS = (
    ...,
    'django_celery_beat',
)
```

–ò –Ω–∞–∫–æ–Ω–µ—Ü —Å–¥–µ–ª–∞–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é –±–¥ `python manage.py migrate`

–û–¥–∏–Ω –∏–∑ —Å–ø–æ—Å–æ–±–æ–≤ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è -- —É–∫–∞–∑–∞–Ω–∏–µ –≤ –∫–æ–Ω—Ñ–∏–≥–µ `Celery` –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:
```py
instructions = {...}
app.conf.beat_schedule = {
    'bb-every-30-seconds': {
        'task': 'proj.tasks.bb_task', # path to the function through the module tree
        'schedule': 30.0,
        'args': (**instructions)
    },
}
app.conf.timezone = 'UTC'
```
–û–± –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö —Å–ø–æ—Å–æ–±–∞—Ö –∑–∞–ø—É—Å–∫–∞ -- [–ø–æ–¥—Ä–æ–±–Ω–µ–µ —Ç—É—Ç](https://docs.celeryproject.org/en/stable/userguide/periodic-tasks.html#beat-custom-schedulers)

### Boot
–ù–∞–∫–æ–Ω–µ—Ü, —á—Ç–æ–±—ã –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤–æ—Ä–∫–µ—Ä Celery, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ: `celery -A proj worker -l INFO`. `-b` –î–æ–±–∞–≤–∏—Ç –∫ –≤–æ—Ä–∫–µ—Ä–∞–º scheduler, –∫–æ—Ç–æ—Ä—ã–π —Å–º–æ–∂–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á.